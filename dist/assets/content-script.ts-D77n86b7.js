const d="yvqf-video-quality-fixing";let r=-1,l;const f=()=>new URL(location.href).pathname==="/watch",h=(t,n=100,o=1e3)=>new Promise(e=>{const i=Date.now()+o,a=window.setInterval(()=>{const s=document.querySelector(t);(s||Date.now()>i)&&(clearInterval(a),e(s))},n)}),g=()=>new Promise(t=>{const n=Date.now()+3e3,o=window.setInterval(()=>{const e=document.querySelector(".ytp-settings-menu .ytp-menuitem:last-child");((e==null?void 0:e.textContent)??"").match(/\d+p/)?(window.clearInterval(o),t(e)):Date.now()>n&&(window.clearInterval(o),t(null))},100)}),p=()=>new Promise(t=>{const n=Date.now()+3e3,o=window.setInterval(()=>{const e=Array.from(document.querySelectorAll(".ytp-settings-menu .ytp-menuitem"));e.length?(window.clearInterval(o),t(e)):Date.now()>n&&(window.clearInterval(o),t([]))},100)}),v=async()=>{try{const{quality:t,shouldUseEnhancedBitrate:n}=l;if(t==="auto")return!0;document.body.classList.add(d);const o=document.querySelector(".ytp-settings-button");if(!o)throw new Error("Settings button not found");o.click();const e=await g();if(!e)throw new Error("Menu not found");e.click();const i=await p();if(!i.length)throw new Error("Submenu not found");const a=[144,240,360,480,720,1080,1440,2160,4320].filter(c=>c<=t),s=i.find(c=>{const w=(c==null?void 0:c.textContent)??"";if(w.includes("Premium")&&!n)return!1;const y=Number(w.split("p")[0]);return a.includes(y)});if(!s)throw new Error("Submenu not match");return s.click(),!0}catch{return!1}finally{document.body.classList.remove(d)}},u=async()=>new Promise(t=>{const n=document.querySelector("ytd-watch-flexy video.html5-main-video");n&&n.removeEventListener("play",u),r&&window.clearTimeout(r);const o=Date.now()+3e3,e=async()=>{if(Date.now()>o)return window.clearTimeout(r),t(!1);if(await v())return window.clearTimeout(r),t(!0);r=window.setTimeout(e)};r=window.setTimeout(e,100)}),m=async()=>{if(!f()||await u())return;const n=await h("ytd-watch-flexy video.html5-main-video");n==null||n.addEventListener("play",u)};chrome.runtime.onMessage.addListener((t,n,o)=>{const{type:e,data:i}=t;switch(e){case"url-changed":return m().then(()=>o()),!0;case"settings-changed":return l=i.settings,o()}});chrome.runtime.sendMessage({type:"content-loaded"}).then(async t=>{l=t.settings,await m()});
